<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Negocia√ß√£o Amig√°vel - LucIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      #chat-box {
        height: 400px;
        overflow-y: auto;
      }

      .bubble-user {
        background: #dcf8c6;
        align-self: flex-end;
      }

      .bubble-bot {
        background: #f0f0f0;
        align-self: flex-start;
      }

      .typing-indicator {
        display: flex;
        gap: 4px;
      }

      .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #999;
        animation: typing 1.4s infinite;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          opacity: 0.5;
        }
        30% {
          opacity: 1;
        }
      }
    </style>
  </head>

  <body class="bg-gray-100 h-screen flex items-center justify-center">
    <div class="w-full max-w-md bg-white rounded-lg shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-blue-600 p-4 text-white flex items-center">
        <div
          class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-600 font-bold mr-3"
        >
          L
        </div>
        <div>
          <h1 class="font-bold">LucIA</h1>
          <p class="text-xs opacity-80">Assistente de Negocia√ß√£o</p>
        </div>
      </div>

      <div class="flex gap-2 p-2 bg-gray-100 border-b">
        <button
          onclick="gerarRelatorio()"
          class="bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded flex-1"
          title="Abrir relat√≥rio do di√°logo em uma nova aba"
        >
          üìä Relat√≥rio
        </button>
        <button
          onclick="limparConversa()"
          class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded flex-1"
          title="Limpar conversa"
        >
          üóëÔ∏è Limpar
        </button>
      </div>

      <!-- Chat Box -->
      <div id="chat-box" class="p-4 flex flex-col space-y-3 bg-gray-50">
        <div class="bubble-bot p-3 rounded-lg text-sm max-w-[80%]">
          Ol√°! Sou a LucIA. Vi que voc√™ possui uma pend√™ncia conosco e estou
          aqui para te ajudar a regularizar isso da melhor forma poss√≠vel. Como
          voc√™ est√° hoje?
        </div>
      </div>

      <!-- Input -->
      <div class="p-4 border-t flex gap-2">
        <input
          type="text"
          id="user-input"
          placeholder="Digite sua mensagem..."
          class="flex-1 border rounded-lg p-2 outline-none focus:border-blue-500"
        />
        <button
          onclick="enviar()"
          id="btn-enviar"
          class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700"
        >
          ‚ñ∂
        </button>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const btnEnviar = document.getElementById("btn-enviar");

      let dialogo = [];

      async function enviar() {
        const msg = userInput.value.trim();
        if (!msg) return;

        // Adiciona mensagem do usu√°rio na tela
        addBubble(msg, "user");
        userInput.value = "";

        // Bloqueia input enquanto a IA pensa
        userInput.disabled = true;
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = "...";

        // Mostra indicador de digita√ß√£o
        const typingDiv = document.createElement("div");
        typingDiv.className =
          "bubble-bot p-3 rounded-lg flex items-center gap-2";
        typingDiv.innerHTML =
          '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              mensagem: msg,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          // Remove indicador de digita√ß√£o
          typingDiv.remove();

          // Adiciona resposta da IA
          addBubble(data.resposta, "bot");

          if (data.status === "acordo_fechado") {
            userInput.placeholder = "‚úÖ Acordo formalizado!";
            userInput.disabled = true;
            btnEnviar.style.display = "none";
          }
        } catch (e) {
          typingDiv.remove();
          addBubble(
            "Ops, tive um probleminha na conex√£o. Pode repetir?",
            "bot",
          );
          console.error("Erro:", e);
        } finally {
          if (userInput.placeholder !== "‚úÖ Acordo formalizado!") {
            userInput.disabled = false;
            btnEnviar.disabled = false;
            btnEnviar.innerHTML = "‚ñ∂";
            userInput.focus();
          }
        }
      }

      function addBubble(text, type, tsIso) {
        const ts = tsIso ? new Date(tsIso) : new Date();
        const iso = ts.toISOString();

        // salva no hist√≥rico local
        dialogo.push({
          role: type === "user" ? "user" : "assistant",
          text,
          ts: iso,
        });

        const div = document.createElement("div");
        div.className = `p-3 rounded-lg text-sm max-w-[80%] ${type === "user" ? "bubble-user" : "bubble-bot"}`;

        const hora = ts.toLocaleString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        div.innerHTML = `
                <div style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(text)}</div>
                <div class="text-[10px] opacity-60 mt-1">${hora}</div>
            `;

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function limparConversa() {
        if (!confirm("Deseja realmente limpar a conversa e come√ßar do zero?"))
          return;

        try {
          // Limpa a sess√£o no servidor
          await fetch("/api/limpar-sessao", {
            method: "POST",
          });

          // Limpa a tela
          chatBox.innerHTML =
            '<div class="bubble-bot p-3 rounded-lg text-sm max-w-[80%]">Ol√°! Sou a LucIA. Vi que voc√™ possui uma pend√™ncia conosco e estou aqui para te ajudar a regularizar isso da melhor forma poss√≠vel. Como voc√™ est√° hoje?</div>';

          // Reabilita o input
          userInput.disabled = false;
          userInput.placeholder = "Digite sua mensagem...";
          btnEnviar.style.display = "inline-block";
          btnEnviar.innerHTML = "‚ñ∂";
          userInput.focus();
          dialogo = [];
        } catch (e) {
          alert("Erro ao limpar sess√£o");
          console.error("Erro:", e);
        }
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function gerarRelatorio() {
        const w = window.open("", "_blank");
        if (!w) {
          alert(
            "Seu navegador bloqueou a nova aba. Permita pop-ups para gerar o relat√≥rio.",
          );
          return;
        }

        const linhas = dialogo
          .map((m) => {
            const quando = new Date(m.ts).toLocaleString("pt-BR");
            const quem = m.role === "user" ? "Voc√™" : "LucIA";
            return `
                    <div class="msg ${m.role}">
                        <div class="meta">
                        <span class="who">${escapeHtml(quem)}</span>
                        <span class="when">${escapeHtml(quando)}</span>
                        </div>
                        <div class="text">${escapeHtml(m.text).replaceAll("\n", "<br>")}</div>
                    </div>
                    `;
          })
          .join("\n");

        const geradoEm = new Date().toLocaleString("pt-BR");

        const html = `
                            <!doctype html>
                            <html lang="pt-br">
                            <head>
                            <meta charset="utf-8" />
                            <meta name="viewport" content="width=device-width, initial-scale=1" />
                            <title>Relat√≥rio do Di√°logo - LucIA</title>
                            <style>
                                body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; padding:24px; }
                                .wrap { max-width: 900px; margin: 0 auto; }
                                h1 { margin: 0 0 6px 0; font-size: 18px; }
                                .sub { color:#555; margin: 0 0 18px 0; font-size: 12px; }
                                .msg { background:#fff; border:1px solid #e7e7e7; border-radius:10px; padding:12px 12px; margin: 10px 0; }
                                .msg.user { border-left: 4px solid #22c55e; }
                                .msg.assistant { border-left: 4px solid #3b82f6; }
                                .meta { display:flex; justify-content:space-between; gap:12px; color:#666; font-size: 12px; margin-bottom: 8px; }
                                .who { font-weight:700; color:#111; }
                                .text { color:#111; font-size: 14px; line-height: 1.45; white-space: normal; }
                                .actions { margin: 14px 0 0; display:flex; gap:8px; }
                                button { cursor:pointer; border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius:8px; }
                                button:hover { background:#f2f2f2; }
                            </style>
                            </head>
                            <body>
                            <div class="wrap">
                                <h1>Relat√≥rio do Di√°logo (LucIA)</h1>
                                <p class="sub">Gerado em: ${escapeHtml(geradoEm)}</p>

                                <div class="actions">
                                <button onclick="window.print()">üñ®Ô∏è Imprimir / Salvar em PDF</button>
                                <button onclick="navigator.clipboard.writeText(document.body.innerText); alert('Copiado!')">üìã Copiar texto</button>
                                </div>

                                ${linhas || '<div class="msg"><div class="text">Nenhuma mensagem registrada ainda.</div></div>'}
                            </div>
                            </body>
                            </html>`;

        w.document.open();
        w.document.write(html);
        w.document.close();
      }

      // Enviar com Enter
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !userInput.disabled) enviar();
      });

      // Focus inicial
      userInput.focus();
    </script>
  </body>
</html>
